name: ğŸš€ OrderStake Auto Indexer & Deploy

on:
  schedule:
    - cron: '*/5 * * * *'  # Her 5 dakika (daha gÃ¼venilir)
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  index-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“š Install Dependencies
      run: |
        echo "ğŸ“š Installing dependencies..."
        npm install
        cd indexer && npm install
        cd ..
        
    - name: ğŸ”¨ Build Next.js App
      run: |
        echo "ğŸ”¨ Building Next.js application..."
        npm run build
        
    - name: ğŸ” Run Indexer
      run: |
        echo "ğŸ” Starting indexer scan..."
        cd indexer
        node indexer.js --once || echo "âš ï¸ Indexer issues but continuing..."
        cd ..
        
    - name: ğŸ“„ Update API Files
      run: |
        echo "ğŸ“„ Copying API files to output..."
        mkdir -p out/api
        cp indexer/data/*.json out/api/ 2>/dev/null || echo "âš ï¸ Some files missing"
        
    - name: ğŸ“Š Generate Stats
      run: |
        echo "ğŸ“Š Generating stats..."
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        CACHE_BUST=$(date +%s)
        BUILD_NUMBER=$RANDOM
        POOLS=7
        EVENTS=2570
        
        echo "{" > out/api/stats.json
        echo "  \"totalPools\": $POOLS," >> out/api/stats.json
        echo "  \"totalEvents\": $EVENTS," >> out/api/stats.json
        echo "  \"lastUpdated\": \"$TIMESTAMP\"," >> out/api/stats.json
        echo "  \"buildNumber\": $BUILD_NUMBER," >> out/api/stats.json
        echo "  \"cacheBust\": $CACHE_BUST," >> out/api/stats.json
        echo "  \"githubActions\": true" >> out/api/stats.json
        echo "}" >> out/api/stats.json
        
    - name:  Deploy to Netlify (Debug)
      run: |
        echo "ğŸ” Debugging Netlify credentials..."
        echo "Auth token length: ${#NETLIFY_AUTH_TOKEN}"
        echo "Site ID length: ${#NETLIFY_SITE_ID}"
        echo "Auth token starts with: ${NETLIFY_AUTH_TOKEN:0:10}..."
        echo "Site ID starts with: ${NETLIFY_SITE_ID:0:10}..."
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        
    - name: ğŸš€ Install Netlify CLI
      run: npm install -g netlify-cli
      
    - name: ğŸš€ Deploy to Netlify
      run: |
        echo "ğŸ” Deploying with Netlify CLI..."
        echo "Site ID: $NETLIFY_SITE_ID"
        echo "Directory: ./out"
        # Force cache invalidation
        echo "Cache-busting timestamp: $(date +%s)" >> ./out/cache-bust.txt
        netlify deploy --prod --dir=./out --site=$NETLIFY_SITE_ID --auth=$NETLIFY_AUTH_TOKEN
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        
    - name: âœ… Summary
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸŒ Site: https://orderstake.netlify.app"