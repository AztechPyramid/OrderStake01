name: 🚀 OrderStake Auto Indexer & Deploy

on:
  schedule:
    - cron: '*/5 * * * *'  # Her 5 dakika (daha güvenilir)
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  index-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: 📚 Install Dependencies
      run: |
        echo "📚 Installing dependencies..."
        npm install
        cd indexer && npm install
        cd ..
        
    - name: 🔨 Build Next.js App
      run: |
        echo "🔨 Building Next.js application..."
        npm run build
        
    - name: 🔍 Run Indexer
      run: |
        echo "🔍 Starting indexer scan..."
        cd indexer
        node indexer.js --once || echo "⚠️ Indexer issues but continuing..."
        cd ..
        
    - name: 📄 Update API Files
      run: |
        echo "📄 Copying API files to output..."
        mkdir -p out/api
        cp indexer/data/*.json out/api/ 2>/dev/null || echo "⚠️ Some files missing"
        
    - name: 📊 Generate Stats
      run: |
        echo "📊 Generating stats..."
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        CACHE_BUST=$(date +%s)
        BUILD_NUMBER=$RANDOM
        POOLS=7
        EVENTS=2570
        
        echo "{" > out/api/stats.json
        echo "  \"totalPools\": $POOLS," >> out/api/stats.json
        echo "  \"totalEvents\": $EVENTS," >> out/api/stats.json
        echo "  \"lastUpdated\": \"$TIMESTAMP\"," >> out/api/stats.json
        echo "  \"buildNumber\": $BUILD_NUMBER," >> out/api/stats.json
        echo "  \"cacheBust\": $CACHE_BUST," >> out/api/stats.json
        echo "  \"githubActions\": true" >> out/api/stats.json
        echo "}" >> out/api/stats.json
        
    - name:  Deploy to Netlify (Debug)
      run: |
        echo "🔍 Debugging Netlify credentials..."
        echo "Auth token length: ${#NETLIFY_AUTH_TOKEN}"
        echo "Site ID length: ${#NETLIFY_SITE_ID}"
        echo "Auth token starts with: ${NETLIFY_AUTH_TOKEN:0:10}..."
        echo "Site ID starts with: ${NETLIFY_SITE_ID:0:10}..."
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        
    - name: 🚀 Install Netlify CLI
      run: npm install -g netlify-cli
      
    - name: 🚀 Deploy to Netlify
      run: |
        echo "🔍 Deploying with Netlify CLI..."
        echo "Site ID: $NETLIFY_SITE_ID"
        echo "Directory: ./out"
        # Force cache invalidation
        echo "Cache-busting timestamp: $(date +%s)" >> ./out/cache-bust.txt
        netlify deploy --prod --dir=./out --site=$NETLIFY_SITE_ID --auth=$NETLIFY_AUTH_TOKEN
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        
    - name: ✅ Summary
      run: |
        echo "🎉 Deployment completed!"
        echo "🌐 Site: https://orderstake.netlify.app"